<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家庭記帳工具</title>
    
    <!-- APP 圖示與 PWA 設定 -->
    <meta name="theme-color" content="#10b981">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512x512.png">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="font-sans text-slate-800 pb-32">

    <!-- 頂部區塊 -->
    <header class="pt-12 px-6 pb-4">
        <!-- 餘額卡片 -->
        <div id="balance-card" class="relative overflow-hidden rounded-3xl p-6 text-white shadow-lg transition-all duration-300 bg-gradient-to-br from-emerald-500 to-teal-600">
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2 opacity-90">
                    <span id="balance-status-text" class="text-sm font-medium tracking-wide">目前狀態</span>
                    <i data-lucide="wallet" class="w-5 h-5 opacity-80"></i>
                </div>
                <div class="flex items-baseline gap-1 mb-4">
                    <span id="balance-amount" class="text-4xl font-bold tracking-tight">$0</span>
                    <span class="text-sm opacity-80 font-medium">TWD</span>
                </div>
                <div class="flex items-center justify-end" id="settle-btn-container">
                    <!-- JS 會在這裡動態插入結算按鈕 -->
                </div>
            </div>
            <!-- 裝飾背景 -->
            <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl pointer-events-none"></div>
        </div>
    </header>

    <!-- 列表區塊 -->
    <main class="px-4">
        <div class="flex items-center justify-between mb-4 px-2">
            <h2 class="text-lg font-bold text-gray-700">近期記錄</h2>
            <span id="tx-count" class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">0 筆</span>
        </div>
        <div id="transaction-list" class="space-y-3 pb-24">
            <div class="flex flex-col items-center justify-center h-48 text-gray-400">
                <i data-lucide="calendar" class="w-12 h-12 mb-2 opacity-20"></i>
                <p>目前沒有記錄</p>
            </div>
        </div>
    </main>

    <!-- 底部功能列 -->
    <div class="fixed bottom-0 left-0 right-0 pb-10 p-4 bg-white border-t border-gray-100 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
        <div class="max-w-md mx-auto flex items-center justify-between gap-3">
            <button onclick="app.openClearSettledModal()" id="btn-clear-settled" class="flex items-center justify-center p-3 rounded-2xl transition-all w-12 h-12 flex-shrink-0 bg-gray-50 text-gray-300 cursor-not-allowed">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
            <button onclick="app.prepareExport()" class="flex-1 h-12 bg-indigo-500 hover:bg-indigo-600 text-white rounded-2xl flex items-center justify-center gap-2 font-bold shadow-lg shadow-indigo-200 active:scale-[0.98]">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span>匯出文字</span>
            </button>
            <button onclick="app.openManualModal()" class="flex-1 h-12 bg-emerald-500 hover:bg-emerald-600 text-white rounded-2xl flex items-center justify-center gap-2 font-bold shadow-lg shadow-emerald-200 active:scale-[0.98]">
                <i data-lucide="plus" class="w-5 h-5"></i>
                <span>手動記帳</span>
            </button>
        </div>
    </div>

    <!-- ================= Modals ================= -->

    <!-- 手動記帳 Modal -->
    <div id="modal-manual" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">新增記錄</h2>
                <button onclick="app.closeModal('modal-manual')" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
            </div>
            <form id="form-add" onsubmit="app.handleAddSubmit(event)" class="space-y-4">
                <div class="flex items-center gap-3">
                    <label class="text-sm font-medium text-gray-500 w-16">誰付錢</label>
                    <div class="flex gap-2 flex-1">
                        <button type="button" onclick="app.setPayer('ME')" id="btn-payer-me" class="flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold transition-all border-indigo-500 bg-indigo-50 text-indigo-700">筠付 (我)</button>
                        <button type="button" onclick="app.setPayer('FRIEND')" id="btn-payer-friend" class="flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold transition-all border-gray-100 text-gray-400">古付</button>
                    </div>
                </div>
                <div class="space-y-3">
                    <input type="text" id="input-item" placeholder="項目 (例如：餐費)" class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required>
                    <input type="number" id="input-amount" placeholder="金額" class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-lg font-medium" required inputmode="decimal">
                    <input type="date" id="input-date" class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500" required>
                </div>
                <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4">新增記錄</button>
            </form>
        </div>
    </div>

    <!-- 匯出預覽 Modal -->
    <div id="modal-export" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">匯出預覽</h2>
                <button onclick="app.closeModal('modal-export')" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 rounded-2xl p-4 mb-6 border border-gray-100 text-sm font-mono text-gray-600 whitespace-pre-wrap leading-relaxed no-scrollbar" id="export-preview-content"></div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="app.copyExportText()" class="bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    <span>複製文字</span>
                </button>
                <button onclick="app.closeModal('modal-export')" class="bg-gray-100 text-gray-600 font-bold py-3 rounded-xl">關閉</button>
            </div>
        </div>
    </div>

    <script type="module">
        const STORAGE_KEY = 'duodebt_static_v1';
        const state = { transactions: [], payer: 'ME' };

        function init() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) state.transactions = JSON.parse(saved);
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
            render();
            lucide.createIcons();
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.transactions));
            render();
        }

        function render() {
            let net = 0;
            let hasSettled = false;
            const sorted = [...state.transactions].sort((a, b) => b.createdAt - a.createdAt);

            sorted.forEach(t => {
                if (t.isSettled) { hasSettled = true; return; }
                if (t.payer === 'ME') net += t.amount; 
                else net -= t.amount; 
            });

            const card = document.getElementById('balance-card');
            const statusText = document.getElementById('balance-status-text');
            const amountText = document.getElementById('balance-amount');
            const settleBtnContainer = document.getElementById('settle-btn-container');

            amountText.innerText = `$${Math.abs(net).toLocaleString()}`;
            card.className = "relative overflow-hidden rounded-3xl p-6 text-white shadow-lg transition-all duration-300";
            
            if (net === 0) {
                statusText.innerText = "目前狀態";
                card.classList.add('bg-gradient-to-br', 'from-gray-500', 'to-slate-600');
                settleBtnContainer.innerHTML = `<div class="flex items-center gap-1 text-white/80 text-sm font-medium px-2 py-2"><i data-lucide="check-circle" class="w-4 h-4"></i> 已全部結清</div>`;
            } else {
                statusText.innerText = net > 0 ? "待收款" : "待付款";
                if (net > 0) card.classList.add('bg-gradient-to-br', 'from-emerald-500', 'to-teal-600');
                else card.classList.add('bg-gradient-to-br', 'from-rose-500', 'to-pink-600');

                settleBtnContainer.innerHTML = `
                    <button onclick="app.settleAll()" class="flex items-center gap-1 bg-white/20 hover:bg-white/30 backdrop-blur-sm px-4 py-2 rounded-xl text-sm font-bold transition-colors shadow-sm">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> 結算全部
                    </button>`;
            }

            const listEl = document.getElementById('transaction-list');
            document.getElementById('tx-count').innerText = `${state.transactions.length} 筆`;

            if (state.transactions.length === 0) {
                listEl.innerHTML = `<div class="flex flex-col items-center justify-center h-48 text-gray-400"><i data-lucide="calendar" class="w-12 h-12 mb-2 opacity-20"></i><p>目前沒有記錄</p></div>`;
            } else {
                listEl.innerHTML = sorted.map(t => {
                    const isMe = t.payer === 'ME';
                    const isSettled = t.isSettled;
                    let amountColor = isSettled ? 'text-gray-400 line-through decoration-2' : (isMe ? 'text-emerald-600' : 'text-rose-600');
                    let iconBg = isSettled ? 'bg-gray-200 text-gray-400' : (isMe ? 'bg-indigo-50 text-indigo-600' : 'bg-orange-50 text-orange-600');
                    let prefix = isSettled ? '' : (isMe ? '+' : '-');

                    return `
                    <div class="${isSettled ? 'bg-gray-50 border-gray-100' : 'bg-white border-gray-100'} rounded-2xl p-4 shadow-sm border flex justify-between items-center transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full ${iconBg} flex-shrink-0 w-9 h-9 flex items-center justify-center">
                                <span class="text-xs font-bold">${isMe ? '筠' : '古'}</span>
                            </div>
                            <div class="min-w-0">
                                <h3 class="font-semibold truncate ${isSettled ? 'text-gray-500' : 'text-gray-800'}">${t.item}</h3>
                                <p class="text-xs text-gray-400">${t.date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pl-2">
                            <div class="text-right flex-shrink-0 ${amountColor}">
                                <div class="font-bold text-lg">${prefix}$${t.amount.toLocaleString()}</div>
                                <p class="text-[10px] uppercase tracking-wider font-semibold opacity-60">${isSettled ? '已結清' : (isMe ? '先墊' : '代墊')}</p>
                            </div>
                            <button onclick="app.deleteTx('${t.id}')" class="text-gray-300 hover:text-red-500 p-2 -mr-2 rounded-full transition-all"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }

            const clearBtn = document.getElementById('btn-clear-settled');
            if (hasSettled) {
                clearBtn.disabled = false;
                clearBtn.className = "flex items-center justify-center p-3 rounded-2xl transition-all w-12 h-12 flex-shrink-0 bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-500";
            } else {
                clearBtn.disabled = true;
                clearBtn.className = "flex items-center justify-center p-3 rounded-2xl transition-all w-12 h-12 flex-shrink-0 bg-gray-50 text-gray-300 cursor-not-allowed";
            }
            lucide.createIcons();
        }

        window.app = {
            openManualModal: () => document.getElementById('modal-manual').classList.remove('hidden'),
            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            setPayer: (payer) => {
                state.payer = payer;
                const btnMe = document.getElementById('btn-payer-me'), btnFriend = document.getElementById('btn-payer-friend');
                if (payer === 'ME') {
                    btnMe.className = "flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold border-indigo-500 bg-indigo-50 text-indigo-700";
                    btnFriend.className = "flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold border-gray-100 text-gray-400";
                } else {
                    btnMe.className = "flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold border-gray-100 text-gray-400";
                    btnFriend.className = "flex-1 py-2 px-3 rounded-xl border-2 text-sm font-bold border-orange-500 bg-orange-50 text-orange-700";
                }
            },
            handleAddSubmit: (e) => {
                e.preventDefault();
                const item = document.getElementById('input-item').value, amount = parseFloat(document.getElementById('input-amount').value), date = document.getElementById('input-date').value;
                if (!item || isNaN(amount)) return;
                state.transactions.unshift({ id: crypto.randomUUID(), date, item, amount, payer: state.payer, createdAt: Date.now(), isSettled: false });
                save();
                document.getElementById('input-item').value = '';
                document.getElementById('input-amount').value = '';
                app.setPayer('ME');
                app.closeModal('modal-manual');
            },
            deleteTx: (id) => {
                if(confirm('確定要刪除這筆記錄嗎？')) { state.transactions = state.transactions.filter(t => t.id !== id); save(); }
            },
            settleAll: () => {
                const unsettledCount = state.transactions.filter(t => !t.isSettled).length;
                if (unsettledCount === 0) return;
                if(confirm(`防呆視窗：確定要結清目前的 ${unsettledCount} 筆項目嗎？結清後餘額將歸零並標記為灰色。`)) {
                    state.transactions = state.transactions.map(t => ({ ...t, isSettled: true }));
                    save();
                }
            },
            openClearSettledModal: () => {
                if(confirm('確定要永久刪除所有「已結算」的紀錄嗎？')) { state.transactions = state.transactions.filter(t => !t.isSettled); save(); }
            },
            prepareExport: () => {
                const unsettled = state.transactions.filter(t => !t.isSettled);
                if (unsettled.length === 0) { alert('目前沒有未結清紀錄可以匯出。'); return; }
                
                let text = "", net = 0;
                [...unsettled].reverse().forEach(t => {
                    const dateParts = t.date.split('-');
                    const displayDate = dateParts.length === 3 ? `${dateParts[1]}-${dateParts[2]}` : t.date;
                    const prefix = t.payer === 'ME' ? "+" : "-";
                    text += `${displayDate} ${t.item} ${prefix}$${t.amount.toLocaleString()}\n`;
                    net += (t.payer === 'ME' ? t.amount : -t.amount);
                });
                
                const label = net > 0 ? '待收款' : '待付款';
                const netPrefix = net > 0 ? "+" : (net < 0 ? "-" : "");
                text += `\n合計：${netPrefix}$${Math.abs(net).toLocaleString()} ${label}`;

                document.getElementById('export-preview-content').innerText = text;
                document.getElementById('modal-export').classList.remove('hidden');
                lucide.createIcons();
            },
            copyExportText: () => {
                const text = document.getElementById('export-preview-content').innerText;
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try { document.execCommand('copy'); showToast('文字已複製！'); } catch (err) { alert('無法複製'); }
                document.body.removeChild(textarea);
            }
        };

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = "fixed top-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg z-[100] animate-fade-in text-sm font-bold";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        init();
    </script>
</body>
</html>
